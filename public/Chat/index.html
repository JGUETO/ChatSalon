<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
	<link rel="stylesheet" href="Chat/estilos.css">
    <meta name="description" content="This module simply initializes socket.io and configures it in a way that single audio/video/screen stream can be shared/relayed over unlimited users without any bandwidth/CPU usage issues. Everything happens peer-to-peer!" />
    <meta name="keywords" content="WebRTC,RTCMultiConnection,Demos,Experiments,Samples,Examples" />
	<title> Chat </title>

    <style>
			video {
				object-fit: fill;
				width: 100%;
				max-width: 100%;
			}
			button,
			input,
			select {
				font-weight: normal;
				padding: 2px 4px;
				text-decoration: none;
				display: inline-block;
				text-shadow: none;
				font-size: 16px;
				outline: none;
			}
	
			.make-center {
				text-align: center;
				padding: 5px 10px;
			}
	
			button, input, select {
				font-family: Myriad, Arial, Verdana;
				font-weight: normal;
				border-top-left-radius: 3px;
				border-top-right-radius: 3px;
				border-bottom-right-radius: 3px;
				border-bottom-left-radius: 3px;
				padding: 4px 12px;
				text-decoration: none;
				color: rgb(27, 26, 26);
				display: inline-block;
				box-shadow: rgb(255, 255, 255) 1px 1px 0px 0px inset;
				text-shadow: none;
				background: -webkit-gradient(linear, 0% 0%, 0% 100%, color-stop(0.05, rgb(241, 241, 241)), to(rgb(230, 230, 230)));
				font-size: 20px;
				border: 1px solid red;
				outline:none;
				vertical-align: middle;
			}
			button, select {
				height: 35px;
				margin: 0 5px;
			}
	
			button:hover, input:hover, select:hover {
				background: -webkit-gradient(linear, 0% 0%, 0% 100%, color-stop(5%, rgb(221, 221, 221)), to(rgb(250, 250, 250)));
				border: 1px solid rgb(142, 142, 142);
			}
	
			button:active, input:active, select:active, button:focus, input:focus, select:focus {
				background: -webkit-gradient(linear, 0% 0%, 0% 100%, color-stop(5%, rgb(183, 183, 183)), to(rgb(255, 255, 255)));
				border: 1px solid rgb(142, 142, 142);
			}
			button[disabled], iput[disabled], select[disabled] {
				background: rgb(249, 249, 249);
				border: 1px solid rgb(218, 207, 207);
				color: rgb(197, 189, 189);
			}
			input, input:focus, input:active {
				background: white;
			}
		</style>
	
</head>

<body>
	<script type='text/javascript'>
		if (sessionStorage.getItem("datos") == null) {
			window.location.replace("/");
		}
	</script>
	<nav>
		<div class="nav-wrapper">
			<a href="#" class="brand-logo center black-text logo">Aplicacion para el salon con WebSockets</a>
		</div>
	</nav>
	<div>
		<div class="row">
			<div class="col s1">
				<div class="card-panel grey lighten-3 cardProfesor">
					<div class="boxProfesor col s12">
						<span>Profesor</span>
						<img class="circle" width="30" src="Chat/img/profesor.svg" style="padding-top: 2px;">
						<div id="wave">
							<span class="dot"></span>
							<span class="dot"></span>
							<span class="dot"></span>
						</div>

					</div>
				</div>
				<div class="iconGroup">
					<a href="#modalGrupoTrabajo" data-position="top" data-delay="50" data-tooltip="Crea un grupo de trabajo" class="modal-trigger btn-floating tooltipped btn-large waves-effect waves-light red">
						<i class="material-icons">group</i>
					</a>
				</div>
			</div>
			<div class="col s6">
				<div class="card-panel grey lighten-3 cardGrilla">
					<!-- Tabla -->
					<table id="tablem" class="striped highlight centered responsive-table">
						<tbody class="cuerpoTabla">
							<tr>
								<td class="box"> </td>
								<td class="box"></td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
							</tr>
							<tr>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
							</tr>
							<tr>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
							</tr>
							<tr>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
							</tr>
							<tr>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
							</tr>
							<tr>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
							</tr>
							<tr>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
								<td class="box"> </td>
							</tr>
						</tbody>
					</table>
				</div>
				<div class="card-panel grey lighten-3 cardInput">
					<div class="input-field col s10">
						<i class="material-icons prefix">message</i>
						<input id="mensaje" type="text" style="float:left"></input>
						<label for="textarea1">Escribe algo...</label>
					</div>

					<form id="formSubirImagen" enctype="multipart/form-data" action="/imageUpload" method="post">
						<div class="image-upload col s2">
							<label for="file-input">
								<img src="https://image.flaticon.com/icons/svg/25/25315.svg" />
							</label>

							<input accept="image/*,video/*" name="filetoupload" id="file-input" type="file" />
						</div>
					</form>

				</div>
			</div>

			<div class="col s4">
				<div id="ChatMsj" class="card-panel grey lighten-3 cardChat" style="margin-bottom: 0px;">

				</div>
				<div class="card-panel grey lighten-3 cardInput" style="margin-left: 20px;">
					<a class="col s5 botonEnviarMensaje waves-effect waves-light red btn-large">
						<i class="material-icons right">send</i>Enviar</a>
					<a class="col s6 botonCrearEncuesta waves-effect modal-trigger waves-light teal darken-1 btn-large" href="#modal1">
						<i class="material-icons right">format_indent_increase</i>Nueva Encuesta</a>

					<!-- Modal Structure -->
					<div id="modal2" class="modal modalEncuestaCliente">
						<form class="formsendREncuesta">
							<div class="modal-content">
								
								<ul class="pagination btnSelEncuesta"></ul>
								<input id="idEncuesta" type='hidden' />
								<i class="material-icons prefix">question</i>
								<h4 class="preguntaModalNuevo">¿Ella te ama?</h4>
								<p>
									<b>A.</b>
									<input class="with-gap" name="group1" type="radio" id="0" />
									<label for="0" class="opcion1ModalNuevo">OpcionA</label>
								</p>
								<p>
									<b>B.</b>
									<input class="with-gap" name="group1" type="radio" id="1" />
									<label for="1" class="opcion2ModalNuevo">OpcionB</label>
								</p>
								<p>
									<b>C.</b>
									<input class="with-gap" name="group1" type="radio" id="2" />
									<label for="2" class="opcion3ModalNuevo">OpcionC</label>
								</p>
								<p>
									<b>D.</b>
									<input class="with-gap" name="group1" type="radio" id="3" />
									<label for="3" class="opcion4ModalNuevo">OpcionD</label>
								</p>


							</div>
							<div class="modal-footer">
								<button href="#!" type="submit" class="modal-action waves-effect waves-green btn">
									<i class="material-icons right">navigate_next</i>Enviar</buttona>
							</div>
						</form>
					</div>

					<!-- Modal Structure -->
					<div id="modal1" class="modal modalEncuesta">
						<div class="modal-content">
							<form class="formEncuesta">
								<center>
									<h4>Añadir nueva encuesta</h4>
								</center>
								<div class="col s1">
								</div>

								<div class="input-field col s10">
									<i class="material-icons prefix">help</i>
									<input type="text" name="preguntaInput" required class="validate">
									<label>Pregunta</label>
								</div>
								<div class="input-field col s6">
									<i class="material-icons prefix">label</i>
									<input name="opcion1Input" type="text" required class="validate">
									<label>Opcion A</label>
								</div>
								<div class="input-field col s6">
									<i class="material-icons prefix">label</i>
									<input name="opcion2Input" type="text" required class="validate">
									<label>Opcion B</label>
								</div>
								<div class="input-field col s6">
									<i class="material-icons prefix">label</i>
									<input name="opcion3Input" type="text" required class="validate">
									<label>Opcion C</label>
								</div>
								<div class="input-field col s6">
									<i class="material-icons prefix">label</i>
									<input name="opcion4Input" type="text" required class="validate">
									<label>Opcion D</label>
								</div>

						</div>
						<div class="modal-footer">
							<center>
								<button type="submit" href="#!" class="modal-action waves-effect waves-green btn-large sendEncuesta">Crear</button>
							</center>
						</div>
						</form>
					</div>
				</div>

			</div>

			<div class="col s1"></div>
		</div>
	</div>

	<!-- Modal Structure -->
	<div id="modal4" class="modal">
		<div class="modal-content">
			<ul class="pagination" id="contenedorPagination"></ul>
			<h4 id="preguntaCanvas">Selecciona una encuesta</h4>
			<div id='contenedorCanvas'>
				<!-- <canvas id="oilChart" width="40" height="40"></canvas> -->
			</div>
		</div>
	</div>

	<div class="fixed-action-btn botonRespuestaEncuestas">
		<a href="#modal4" class="btn-floating btn-large red modal-trigger">
			<i class="large material-icons">timeline</i>
		</a>
	</div>

	<!-- Modal mensaje privado -->
	<div id="modalPv2" class="modal">
		<div class="modal-content">
			<h4 class="center">Mensaje Privado</h4>
			<div id="BandejaPv2" class="card-panel grey lighten-3 cardChatPv2" style="margin-bottom: 0px;">

			</div>

			<div class="card-panel grey lighten-3 cardInputPv2 row" style="margin-left: 20px;">

				<div class="input-field col s10">
					<i class="material-icons prefix">message</i>
					<input id="mensajePv2" type="text" style="float:left"></input>
					<label for="textarea1">Escribe algo...</label>
				</div>

				<form id="formSubirImagenPv2" enctype="multipart/form-data" action="/imageUpload" method="post">
					<div class="image-upload col s2">
						<label for="file-inputpv2">
							<img src="https://image.flaticon.com/icons/svg/25/25315.svg" />
						</label>

						<input accept="image/*,video/*" name="filetouploadpv2" id="file-inputpv2" type="file" />
					</div>
				</form>

			</div>

			<p></p>
		</div>
	</div>

	<!-- Modal mensaje privado -->
	<div id="modalPg2" class="modal">
		<div class="modal-content">
			<h4 class="center">Mensaje Grupal</h4>
			<div id="BandejaPg2" class="card-panel grey lighten-3 cardChatPg2" style="margin-bottom: 0px;">

			</div>

			<div class="card-panel grey lighten-3 cardInputPg2 row" style="margin-left: 20px;">

				<div class="input-field col s10">
					<i class="material-icons prefix">message</i>
					<input id="mensajePg2" type="text" style="float:left"></input>
					<label for="textarea1">Escribe algo...</label>
				</div>

				<form id="formSubirImagenPg2" enctype="multipart/form-data" action="/imageUpload" method="post">
					<div class="image-upload col s2">
						<label for="file-inputpg2">
							<img src="https://image.flaticon.com/icons/svg/25/25315.svg" />
						</label>

						<input accept="image/*,video/*" name="filetouploadpg2" id="file-inputpg2" type="file" />
					</div>
				</form>

			</div>

			<p></p>
		</div>
	</div>

	<!--- MODAL SELECCION DE ENCUESTA -->
	<div id="modalSelEncuesta" class="modal">
		<div class="modal-content">
			<h4>Selecciona una encuesta</h4>
			<div class="btnSelEncuesta col s12"></div>
		</div>
	</div>

	<div id="modalGrupoTrabajo" class="modal">
		<div class="modal-content">
			<h4>Selecciona tu grupo de trabajo</h4>
			<div class="tableWorkGroup col s12">
			</div>
		</div>
	</div>

	<div class="tap-target tapNextStep" data-activates="nextStep">
		<div class="tap-target-content">
			<h5>Siguiente paso</h5>
			<p>Da click al terminar de seleccionar tu grupo de estudio</p>
		</div>
	</div>

	<div class="testModal">
		<div class="modal-content">
			<h4>Selecciona un color para identificar tu grupo</h4>
			<div class="selectColor col s12">
				<div class="picker-wrapper">
					<div class="color-picker">
					</div>
				</div>
				<button class="sendColorButton btn-large waves-effect waves-light">Enviar</button>
			</div>
		</div>
	</div>

	<div id="nextStep" class="fixed-action-btn botonSiguiente">
		<a class="modal-trigger btn-floating btn-large waves-effect waves-light red">
			<i class="material-icons">arrow_forward</i>
		</a>
	</div>


    <article>

			<header style="text-align: center;">
				<h1><a href="https://github.com/muaz-khan/WebRTC-Scalable-Broadcast">WebRTC Scalable Screen Broadcast</a> using <a href="https://github.com/muaz-khan/RTCMultiConnection">RTCMultiConnection</a></h1>
				<p>
					<a href="https://rtcmulticonnection.herokuapp.com/">HOME</a>
					<span> &copy; </span>
					<a href="http://www.MuazKhan.com/" target="_blank">Muaz Khan</a> .
					<a href="http://twitter.com/WebRTCWeb" target="_blank" title="Twitter profile for WebRTC Experiments">@WebRTCWeb</a> .
					<a href="https://github.com/muaz-khan?tab=repositories" target="_blank" title="Github Profile">Github</a> .
					<a href="https://github.com/muaz-khan/RTCMultiConnection/issues?state=open" target="_blank">Latest issues</a> .
					<a href="https://github.com/muaz-khan/RTCMultiConnection/commits/master" target="_blank">What's New?</a>
				</p>
			</header>
	
			<div class="github-stargazers"></div>
	
			<section class="experiment">
				<div class="make-center">
					<input type="text" id="broadcast-id" placeholder="broadcast-id" value="room-xyz">
					<button id="open-or-join">Open or Join Broadcast</button>
	
					<div id="room-urls" style="text-align: center;display: none;background: #F1EDED;margin: 15px -10px;border: 1px solid rgb(189, 189, 189);border-left: 0;border-right: 0;"></div>
				</div>
	
				<video id="video-preview" controls loop></video>
			</section>
	
			<blockquote>
				This module simply initializes socket.io and configures it in a way that single audio/video/screen stream can be shared/relayed over unlimited users without any <a href="https://www.webrtc-experiment.com/docs/RTP-usage.html">bandwidth/CPU usage issues</a>. Everything happens peer-to-peer!
	
				<br><br>
				You can try <a href="/demos/Scalable-Broadcast.html">Scalable Video Broadcast</a>!
	
				<br><br>
				Requirements: <a href="https://chrome.google.com/webstore/detail/screen-capturing/ajhifddimkapgcifgcodmmfdlknahffk">install this Chrome extension</a> or <a href="https://addons.mozilla.org/en-US/firefox/addon/enable-screen-capturing/">this Firefox extension</a>.
			</blockquote>
	
	<!-- Footer -->
    <footer class="page-footer  grey lighten-3 black-text">
			<div class="container">
				<div class="row">
					<div class="col l6 s12">
						<h5 class="grey-text">Chat para salón con WebSockets</h5>
					
						<p class="grey-text text-darken-3"> Desarrollado para la asignatura <b>Software para Redes</b> dirigida por Johan Robles en la Universidad del Magdalena </p>
						<img  width="50" src="http://icons.iconarchive.com/icons/thehoth/seo/256/seo-web-code-icon.png"/>
					</div>
					<div class="col l4 offset-l2 s12">
						<h5 class="grey-text">Tecnologías</h5>
						<ul class="txtAlign">
							<li>
								<a class="grey-text text-darken-3" href="https://nodejs.org/es/">NodeJS</a>
							</li>
							<li>
								<a class="grey-text text-darken-3" href="http://expressjs.com/es/">ExpressJS</a>
							</li>
							<li>
								<a class="grey-text text-darken-3" href="https://socket.io/">SocketIO</a>
							</li>
							<li>
								<a class="grey-text text-darken-3" href="http://materializecss.com/">MaterializeCSS</a>
							</li>
	
						</ul>
					</div>
				</div>
			</div>
			<div class="footer-copyright">
				<div class="container grey-text text-darken-3">
					
						<i class="material-icons tiny">copyright</i> 2018 Copyright ChatSalon v1.0 | Todos los derechos reservados
					
				   <a class="grey-text text-darken-3 right" href="https://www.facebook.com/TJoseGuerreroT">Jose Guerrero T</a>
					<br>
					<a class="grey-text text-darken-3 right" href="https://www.facebook.com/albeiroenrique.espitiasierra">Albeiro Espitia</a>
				</div> 
			</div>
		</footer>
	

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.js"></script>
	<script src="Chat/libs/piklor.min.js"></script>
	<script src="Chat/libs/piklorColors.js"></script>
	<script src="Chat/libs/RTCMultiConnection.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="https://cdn.webrtc-experiment.com:443/getScreenId.js"></script>
	<script src="Chat/js/init.js"></script>
	<script src="Chat/js/eventosMatriz.js"></script>
	<script src="Chat/js/eventosConexion.js"></script>
	<script src="Chat/js/eventosEncuesta.js"></script>
	<script src="Chat/js/eventosEscribiendo.js"></script>
	<script src="Chat/js/eventosMensaje.js"></script>
	<script src="Chat/js/eventosMensajePrivado.js"></script>
	<script src="Chat/js/eventosGrupoTrabajo.js"></script>
	<script src="Chat/js/eventosMensajeGrupal.js"></script>
	<script src="Chat/js/eventosFotoPerfil.js"></script>
	<script src="Chat/js/eventosRemotos.js"></script>

	<script>
            // recording is disabled because it is resulting for browser-crash
            // if you enable below line, please also uncomment above "RecordRTC.js"
            var enableRecordings = false;

            var connection = new RTCMultiConnection(null, {
                useDefaultDevices: true // if we don't need to force selection of specific devices
            });

            // its mandatory in v3
            connection.enableScalableBroadcast = true;

            // each relaying-user should serve only 1 users
            connection.maxRelayLimitPerUser = 1;

            // we don't need to keep room-opened
            // scalable-broadcast.js will handle stuff itself.
            connection.autoCloseEntireSession = true;

            // by default, socket.io server is assumed to be deployed on your own URL
            //connection.socketURL = '/';

            // comment-out below line if you do not have your own socket.io server
            connection.socketURL = 'https://rtcmulticonnection.herokuapp.com:443/';

            connection.socketMessageEvent = 'scalable-screen-broadcast-demo';

            // user need to connect server, so that others can reach him.
            connection.connectSocket(function(socket1) {
                socket1.on('logs', function(log) {
                    document.querySelector('h1').innerHTML = log.replace(/</g, '----').replace(/>/g, '___').replace(/----/g, '(<span style="color:red;">').replace(/___/g, '</span>)');
                });

                // this event is emitted when a broadcast is already created.
                socket1.on('join-broadcaster', function(hintsToJoinBroadcast) {
                    console.log('join-broadcaster', hintsToJoinBroadcast);

                    connection.session = hintsToJoinBroadcast.typeOfStreams;
                    connection.sdpConstraints.mandatory = {
                        OfferToReceiveVideo: true,
                        OfferToReceiveAudio: false
                    };
                    connection.join(hintsToJoinBroadcast.userid);
                });

                socket1.on('rejoin-broadcast', function(broadcastId) {
                    console.log('rejoin-broadcast', broadcastId);

                    connection.attachStreams = [];
                    socket1.emit('check-broadcast-presence', broadcastId, function(isBroadcastExists) {
                        if(!isBroadcastExists) {
                            // the first person (i.e. real-broadcaster) MUST set his user-id
                            connection.userid = broadcastId;
                        }

                        socket1.emit('join-broadcast', {
                            broadcastId: broadcastId,
                            userid: connection.userid,
                            typeOfStreams: connection.session
                        });
                    });
                });

                socket1.on('broadcast-stopped', function(broadcastId) {
                    // alert('Broadcast has been stopped.');
                    // location.reload();
                    console.error('broadcast-stopped', broadcastId);
                    alert('This broadcast has been stopped.');
                });

                // this event is emitted when a broadcast is absent.
                socket1.on('start-broadcasting', function(typeOfStreams) {
                    console.log('start-broadcasting', typeOfStreams);

                    // host i.e. sender should always use this!
                    connection.sdpConstraints.mandatory = {
                        OfferToReceiveVideo: false,
                        OfferToReceiveAudio: false
                    };
                    connection.session = typeOfStreams;

                    // "open" method here will capture media-stream
                    // we can skip this function always; it is totally optional here.
                    // we can use "connection.getUserMediaHandler" instead
                    connection.open(connection.userid, function() {
						socket.emit('receiveIdBroadcast',broadcastId)
                        showRoomURL(connection.sessionid);
                    });
                });
            });

            window.onbeforeunload = function() {
                // Firefox is ugly.
                document.getElementById('open-or-join').disabled = false;
            };

            var videoPreview = document.getElementById('video-preview');

            connection.onstream = function(event) {
                if(connection.isInitiator && event.type !== 'local') {
                    return;
                }

                if(event.mediaElement) {
                    event.mediaElement.pause();
                    delete event.mediaElement;
                }

                connection.isUpperUserLeft = false;
                videoPreview.src = URL.createObjectURL(event.stream);
                videoPreview.play();

                videoPreview.userid = event.userid;

                if(event.type === 'local') {
                    videoPreview.muted = true;
                }

                if (connection.isInitiator == false && event.type === 'remote') {
                    // he is merely relaying the media
                    connection.dontCaptureUserMedia = true;
                    connection.attachStreams = [event.stream];
                    connection.sdpConstraints.mandatory = {
                        OfferToReceiveAudio: false,
                        OfferToReceiveVideo: false
                    };

                    var socket = connection.getSocket();
                    socket.emit('can-relay-broadcast');

                    if(connection.DetectRTC.browser.name === 'Chrome') {
                        connection.getAllParticipants().forEach(function(p) {
                            if(p + '' != event.userid + '') {
                                var peer = connection.peers[p].peer;
                                peer.getLocalStreams().forEach(function(localStream) {
                                    peer.removeStream(localStream);
                                });
                                peer.addStream(event.stream);
                                connection.dontAttachStream = true;
                                connection.renegotiate(p);
                                connection.dontAttachStream = false;
                            }
                        });
                    }

                    if(connection.DetectRTC.browser.name === 'Firefox') {
                        // Firefox is NOT supporting removeStream method
                        // that's why using alternative hack.
                        // NOTE: Firefox seems unable to replace-tracks of the remote-media-stream
                        // need to ask all deeper nodes to rejoin
                        connection.getAllParticipants().forEach(function(p) {
                            if(p + '' != event.userid + '') {
                                connection.replaceTrack(event.stream, p);
                            }
                        });
                    }

                    // Firefox seems UN_ABLE to record remote MediaStream
                    // WebAudio solution merely records audio
                    // so recording is skipped for Firefox.
                    if(connection.DetectRTC.browser.name === 'Chrome') {
                        repeatedlyRecordStream(event.stream);
                    }
                }
            };

            // ask node.js server to look for a broadcast
            // if broadcast is available, simply join it. i.e. "join-broadcaster" event should be emitted.
            // if broadcast is absent, simply create it. i.e. "start-broadcasting" event should be fired.
            document.getElementById('open-or-join').onclick = function() {
                var broadcastId = document.getElementById('broadcast-id').value;
                if (broadcastId.replace(/^\s+|\s+$/g, '').length <= 0) {
                    alert('Please enter broadcast-id');
                    document.getElementById('broadcast-id').focus();
                    return;
                }

                document.getElementById('open-or-join').disabled = true;

                connection.session = {
                    screen: true,
                    oneway: true
                };

                var socket = connection.getSocket();

                socket.emit('check-broadcast-presence', broadcastId, function(isBroadcastExists) {
                    if(!isBroadcastExists) {
                        // the first person (i.e. real-broadcaster) MUST set his user-id
                        connection.userid = broadcastId;
                    }

                    console.log('check-broadcast-presence', broadcastId, isBroadcastExists);

                    socket.emit('join-broadcast', {
                        broadcastId: broadcastId,
                        userid: connection.userid,
                        typeOfStreams: connection.session
                    });
                });
            };

            connection.onstreamended = function() {};

            connection.onleave = function(event) {
                if(event.userid !== videoPreview.userid) return;

                var socket = connection.getSocket();
                socket.emit('can-not-relay-broadcast');

                connection.isUpperUserLeft = true;

                if(allRecordedBlobs.length) {
                    // playing lats recorded blob
                    var lastBlob = allRecordedBlobs[allRecordedBlobs.length - 1];
                    videoPreview.src = URL.createObjectURL(lastBlob);
                    videoPreview.play();
                    allRecordedBlobs = [];
                }
                else if(connection.currentRecorder) {
                    var recorder = connection.currentRecorder;
                    connection.currentRecorder = null;
                    recorder.stopRecording(function() {
                        if(!connection.isUpperUserLeft) return;

                        videoPreview.src = URL.createObjectURL(recorder.blob);
                        videoPreview.play();
                    });
                }

                if(connection.currentRecorder) {
                    connection.currentRecorder.stopRecording();
                    connection.currentRecorder = null;
                }
            };

            var allRecordedBlobs = [];

            function repeatedlyRecordStream(stream) {
                if(!enableRecordings) {
                    return;
                }

                connection.currentRecorder = RecordRTC(stream, {
                    type: 'video'
                });

                connection.currentRecorder.startRecording();

                setTimeout(function() {
                    if(connection.isUpperUserLeft || !connection.currentRecorder) {
                        return;
                    }

                    connection.currentRecorder.stopRecording(function() {
                        allRecordedBlobs.push(connection.currentRecorder.blob);

                        if(connection.isUpperUserLeft) {
                            return;
                        }

                        connection.currentRecorder = null;
                        repeatedlyRecordStream(stream);
                    });
                }, 30 * 1000); // 30-seconds
            };

            // Using getScreenId.js to capture screen from any domain
            // You do NOT need to deploy Chrome Extension YOUR-Self!!
            connection.getScreenConstraints = function(callback) {
                getScreenConstraints(function(error, screen_constraints) {
                    if (!error) {
                        screen_constraints = connection.modifyScreenConstraints(screen_constraints);
                        callback(error, screen_constraints);
                        return;
                    }
                    throw error;
                });
            };

            function disableInputButtons() {
                document.getElementById('open-or-join').disabled = true;
                document.getElementById('broadcast-id').disabled = true;
            }

            // ......................................................
            // ......................Handling broadcast-id................
            // ......................................................

            function showRoomURL(broadcastId) {
                var roomHashURL = '#' + broadcastId;
                var roomQueryStringURL = '?broadcastId=' + broadcastId;

                var html = '<h2>Unique URL for your room:</h2><br>';

                html += 'Hash URL: <a href="' + roomHashURL + '" target="_blank">' + roomHashURL + '</a>';
                html += '<br>';
                html += 'QueryString URL: <a href="' + roomQueryStringURL + '" target="_blank">' + roomQueryStringURL + '</a>';

                var roomURLsDiv = document.getElementById('room-urls');
                roomURLsDiv.innerHTML = html;

                roomURLsDiv.style.display = 'block';
            }

            (function() {
                var params = {},
                    r = /([^&=]+)=?([^&]*)/g;

                function d(s) {
                    return decodeURIComponent(s.replace(/\+/g, ' '));
                }
                var match, search = window.location.search;
                while (match = r.exec(search.substring(1)))
                    params[d(match[1])] = d(match[2]);
                window.params = params;
            })();

            var broadcastId = '';
            if (localStorage.getItem(connection.socketMessageEvent)) {
                broadcastId = localStorage.getItem(connection.socketMessageEvent);
            } else {
                broadcastId = connection.token();
            }
            document.getElementById('broadcast-id').value = broadcastId;
            document.getElementById('broadcast-id').onkeyup = function() {
                localStorage.setItem(connection.socketMessageEvent, this.value);
            };

            var hashString = location.hash.replace('#', '');
            if(hashString.length && hashString.indexOf('comment-') == 0) {
              hashString = '';
            }

            var broadcastId = params.broadcastId;
            if(!broadcastId && hashString.length) {
                broadcastId = hashString;
            }

            if(broadcastId && broadcastId.length) {
                document.getElementById('broadcast-id').value = broadcastId;
                localStorage.setItem(connection.socketMessageEvent, broadcastId);

                // auto-join-room
                (function reCheckRoomPresence() {
                    connection.checkPresence(broadcastId, function(isRoomExists) {
                        if(isRoomExists) {
                            document.getElementById('open-or-join').onclick();
                            return;
                        }

                        setTimeout(reCheckRoomPresence, 5000);
                    });
                })();

                disableInputButtons();
            }

	</script>


</body>

</html>









<!--var upload = multer({dest:'uploads/'})

app.post('/imageUpload',upload.single('filetoupload'),function(req,res){
    console.log("llego el vale")
})-->